ang1dot = vel1;

vel1dot = R2.*tau1./denom1 ...
  - (R2+L1.*cos(ang2)).*tau2./denom1...
  + num1./denom1;
  
  num1 =(grav.*(M1.*R1.*R2 + M2.*L1.*R2).*sin(ang1) + ...
    (vel1 + vel2).^2.*L1.*M2.*R2.^2.*sin(ang2) - ...
    grav.*M2.*L1.*R2.*sin(ang1+ang2).*cos(ang2) + ...
    M2.*L1.^2.*R2.*vel1.^2.*cos(ang2).*sin(ang2)); 
  
  denom1 =(L1.^2.*M2.*R2 + M1.*R1.^2.*R2 - ...
    L1.^2.*M2.*R2.*cos(ang2).^2);
  
  ang2dot = vel2;
  
vel2dot = ...
-(M2.*R2.^2 + M2.*R2.*L1.*cos(ang2)).*tau1./denom2 ...
-(-M1.*R1.^2 - M2.*R2.^2 - M2.*L1.^2 - 2.*M2.*R2.*L1.*cos(ang2)).*tau2./denom2 +...
num2./denom2;

num2 = (-(M2.^2.*R2.^2.*L1.*grav + M1.*M2.*R1.*R2.^2.*grav).*sin(ang1)+...
-(-M2.^2.*R2.*L1.^2.*grav - M1.*M2.*R1.^2.*R2.*grav).*sin(ang1 + ang2)+...
-((M2.^2.*R2.*L1.^3+M1.*M2.*R1.^2.*R2.*L1).*vel1.^2+(M2.^2.*R2.^3.*L1).*(vel1+vel2).^2).*sin(ang2)+...
-(M2.^2.*R2.*L1.^2.*grav + M1.*M2.*R1.*R2.*L1.*grav).*cos(ang2).*sin(ang1)+...
-(M2.^2.*R2.^2.*L1.^2.*(2.*vel1.^2 + 2.*vel1.*vel2 + vel2.^2)).*cos(ang2).*sin(ang2)+...
 M2.^2.*R2.^2.*L1.*grav.*sin(ang1 + ang2).*cos(ang2));

denom2 = (M2.*R2.^2.*(M1.*R1.^2 + M2.*L1.^2 - M2.*L1.^2.*cos(ang2).^2));

hamiltonian = p{1}.*ang1dot + p{2}.*vel1dot + p{3}.*ang2dot + p{4}.*vel2dot

hamiltonian = p{1}.*vel1 ...
  + p{2}.*(R2.*tau1./denom1 ...
  - (R2+L1.*cos(ang2)).*tau2./denom1...
  + num1./denom1)...
  + p{3}.*vel2...
  + p{4}.*(-(M2.*R2.^2 + M2.*R2.*L1.*cos(ang2)).*tau1./denom2 ...
-(-M1.*R1.^2 - M2.*R2.^2 - M2.*L1.^2 - 2.*M2.*R2.*L1.*cos(ang2)).*tau2./denom2 +...
num2./denom2)

hamiltonian = p{1}.*vel1 + p{3}.*vel2...
  + p{2}.*R2.*tau1./denom1 ...
  - p{2}.*(R2+L1.*cos(ang2)).*tau2./denom1...
  + p{2}.*num1./denom1...
-p{4}.*(M2.*R2.^2 + M2.*R2.*L1.*cos(ang2)).*tau1./denom2 ...
-p{4}.*(-M1.*R1.^2 - M2.*R2.^2 - M2.*L1.^2 - 2.*M2.*R2.*L1.*cos(ang2)).*tau2./denom2 ...
+p{4}.*num2./denom2

hamiltonian = p{1}.*vel1 + p{3}.*vel2 + p{2}.*num1./denom1+p{4}.*num2./denom2
  + tau1.*p{2}.*R2./denom1 ...
  - tau2.*p{2}.*(R2+L1.*cos(ang2))./denom1...
  - tau1.*p{4}.*(M2.*R2.^2 + M2.*R2.*L1.*cos(ang2))./denom2 ...
  - tau2.*p{4}.*(-M1.*R1.^2 - M2.*R2.^2 - M2.*L1.^2 - 2.*M2.*R2.*L1.*cos(ang2))./denom2;

hamiltonian = p{1}.*vel1 + p{3}.*vel2 + p{2}.*num1./denom1+p{4}.*num2./denom2
  + tau1.*p{2}.*R2./denom1 
  - tau1.*p{4}.*(M2.*R2.^2 + M2.*R2.*L1.*cos(ang2))./denom2 ...
  - tau2.*p{2}.*(R2+L1.*cos(ang2))./denom1...
  - tau2.*p{4}.*(-M1.*R1.^2 - M2.*R2.^2 - M2.*L1.^2 - 2.*M2.*R2.*L1.*cos(ang2))./denom2;

hamiltonian = p{1}.*vel1 + p{3}.*vel2 + p{2}.*num1./denom1+p{4}.*num2./denom2
  + tau1.*(p{2}.*R2./denom1 ...
    - p{4}.*(M2.*R2.^2 + M2.*R2.*L1.*cos(ang2))./denom2) ...
  + tau2.*(-p{2}.*(R2+L1.*cos(ang2))./denom1...
    - p{4}.*(-M1.*R1.^2 - M2.*R2.^2 - M2.*L1.^2 - 2.*M2.*R2.*L1.*cos(ang2))./denom2);
  
extraTerms = p{1}.*vel1 + p{3}.*vel2 + p{2}.*num1./denom1+p{4}.*num2./denom2;
tau1Multiplier = (p{2}.*R2./denom1 - p{4}.*(M2.*R2.^2 + M2.*R2.*L1.*cos(ang2))./denom2);
tau2Multiplier = (-p{2}.*(R2+L1.*cos(ang2))./denom1...
    - p{4}.*(-M1.*R1.^2 - M2.*R2.^2 - M2.*L1.^2 - 2.*M2.*R2.*L1.*cos(ang2))./denom2);
  
hamiltonian = extraTerms...
  + tau1.*tau1Multiplier ...
  + tau2.*tau2Multiplier;
  
%minimize over tau1, tau2

hamiltonian = extraTerms...
  + (tau1Multiplier>=0)..*(tau1Multiplier)..*Tau1Min ...
  + (tau1Multiplier<0)..*(tau1Multiplier)..*Tau1Max ...
  + (tau2Multiplier>=0)..*(tau2Multiplier)..*Tau2Min...
  + (tau2Multiplier<0)..*(tau2Multiplier)..*Tau2Max;

%% Things I need
num1 =(grav.*(M1.*R1.*R2 + M2.*L1.*R2).*sin(ang1) + ...
  (vel1 + vel2).^2.*L1.*M2.*R2.^2.*sin(ang2) - ...
  grav.*M2.*L1.*R2.*sin(ang1+ang2).*cos(ang2) + ...
  M2.*L1.^2.*R2.*vel1.^2.*cos(ang2).*sin(ang2));

denom1 =(L1.^2.*M2.*R2 + M1.*R1.^2.*R2 - ...
  L1.^2.*M2.*R2.*cos(ang2).^2);

num2 = (-(M2.^2.*R2.^2.*L1.*grav + M1.*M2.*R1.*R2.^2.*grav).*sin(ang1)+...
  -(-M2.^2.*R2.*L1.^2.*grav - M1.*M2.*R1.^2.*R2.*grav).*sin(ang1 + ang2)+...
  -((M2.^2.*R2.*L1.^3+M1.*M2.*R1.^2.*R2.*L1).*vel1.^2+(M2.^2.*R2.^3.*L1).*(vel1+vel2).^2).*sin(ang2)+...
  -(M2.^2.*R2.*L1.^2.*grav + M1.*M2.*R1.*R2.*L1.*grav).*cos(ang2).*sin(ang1)+...
  -(M2.^2.*R2.^2.*L1.^2.*(2.*vel1.^2 + 2.*vel1.*vel2 + vel2.^2)).*cos(ang2).*sin(ang2)+...
  M2.^2.*R2.^2.*L1.*grav.*sin(ang1 + ang2).*cos(ang2));

denom2 = (M2.*R2.^2.*(M1.*R1.^2 + M2.*L1.^2 - M2.*L1.^2.*cos(ang2).^2));

extraTerms = p{1}.*vel1 + p{3}.*vel2 + p{2}.*num1./denom1+p{4}.*num2./denom2;
tau1Multiplier = (p{2}.*R2./denom1 - p{4}.*(M2.*R2.^2 + M2.*R2.*L1.*cos(ang2))./denom2);
tau2Multiplier = (-p{2}.*(R2+L1.*cos(ang2))./denom1...
  - p{4}.*(-M1.*R1.^2 - M2.*R2.^2 - M2.*L1.^2 - 2.*M2.*R2.*L1.*cos(ang2))./denom2);
  
hamiltonian = extraTerms...
  + (tau1Multiplier>=0).*(tau1Multiplier).*Tau1Min ...
  + (tau1Multiplier<0).*(tau1Multiplier).*Tau1Max ...
  + (tau2Multiplier>=0).*(tau2Multiplier).*Tau2Min...
  + (tau2Multiplier<0).*(tau2Multiplier).*Tau2Max;

%% Partial

hamiltonian = p{1}.*vel1 + p{3}.*vel2...
  + p{2}.*R2.*tau1./denom1 ...
  - p{2}.*(R2+L1.*cos(ang2)).*tau2./denom1...
  + p{2}.*num1./denom1...
-p{4}.*(M2.*R2.^2 + M2.*R2.*L1.*cos(ang2)).*tau1./denom2 ...
-p{4}.*(-M1.*R1.^2 - M2.*R2.^2 - M2.*L1.^2 - 2.*M2.*R2.*L1.*cos(ang2)).*tau2./denom2 ...
+p{4}.*num2./denom2
switch
  case 1
    alpha = abs(vel1)
  case 2
    alpha = abs(R2/denom1).*T1Max + (-(R2+L1.*cos(ang2))./denom1).*T2Max + abs(num1./denom1)
  case 3
    alpha = abs(vel2)
  case 4
    alpha = abs(-(M2.*R2.^2 + M2.*R2.*L1.*cos(ang2))./denom2).*T1Max ...
      + abs(-(-M1.*R1.^2 - M2.*R2.^2 - M2.*L1.^2 - 2.*M2.*R2.*L1.*cos(ang2))./denom2).*T2Max...
      + abs(num2./denom2)